const translations = {
  en: {
    "brand.title": "Free Resume",
    "brand.subtitle": "Design-forward multilingual resume builder",
    "fields.template": "Template",
    "fields.showSkills": "Show skills section",
    "fields.identity": "Identity",
    "fields.fullName": "Full name",
    "fields.headline": "Professional title",
    "fields.email": "Email",
    "fields.phone": "Phone",
    "fields.location": "Location",
    "fields.website": "Website",
    "fields.linkedin": "LinkedIn",
    "fields.github": "GitHub",
    "fields.summary": "Summary",
    "fields.summaryHint": "Write a short professional overview.",
    "fields.experience": "Experience",
    "fields.education": "Education",
    "fields.skills": "Skills",
    "fields.jobTitle": "Job title",
    "fields.company": "Company",
    "fields.itemLocation": "Location",
    "fields.startDate": "Start",
    "fields.endDate": "End",
    "fields.highlights": "Highlights (one per line)",
    "fields.degree": "Degree",
    "fields.school": "School",
    "fields.skillName": "Skill",
    "fields.skillLevel": "Level",
    "fields.showSkillLevel": "Show skill level",
    "fields.cvLanguage": "CV language",
    "actions.darkMode": "Dark mode",
    "actions.lightMode": "Light mode",
    "actions.addExperience": "Add experience",
    "actions.addEducation": "Add education",
    "actions.addSkill": "Add skill",
    "actions.remove": "Remove",
    "actions.uploadRaw": "Upload raw CV",
    "actions.downloadRaw": "Download raw CV",
    "actions.pdf": "Save PDF",
    "errors.invalidRawFile": "Could not import file. Choose a valid Free Resume JSON file.",
    "templates.berlin": "Berlin Classic",
    "templates.aurora": "Aurora Timeline",
    "templates.atelier": "Atelier Grid",
    "templates.noir": "Noir Minimal",
    "templates.fjord": "Fjord Split",
    "templates.solstice": "Solstice Banner",
    "templates.bastion": "Bastion Ledger",
    "templates.slate": "Slate Mono",
    "templates.kernel": "Kernel Systems",
    "templates.alpine": "Alpine Classic",
    "preview.live": "Live preview",
    "preview.blank": "Starts blank",
    "sections.summary": "Profile",
    "sections.experience": "Employment History",
    "sections.education": "Education",
    "sections.skills": "Skills",
    "sections.details": "Details",
    "sections.links": "Links",
    "empty.resumeStart": "Your resume starts blank. Add content from the editor.",
    "empty.experience": "Add your first experience entry.",
    "empty.education": "Add your education history.",
    "empty.skills": "Add skills to highlight your strengths.",
    "empty.experienceEditor": "No experience entries yet.",
    "empty.educationEditor": "No education entries yet.",
    "empty.skillsEditor": "No skills added yet.",
    "placeholders.name": "John Doe",
    "placeholders.title": "Your Professional Title",
    "placeholders.email": "name@example.com",
    "placeholders.phone": "+49 000 000000",
    "placeholders.location": "Berlin, Germany",
    "placeholders.website": "yourwebsite.dev",
    "placeholders.linkedin": "linkedin.com/in/username",
    "placeholders.github": "github.com/username",
    "placeholders.summary": "Infrastructure engineer with a strong automation mindset...",
    "placeholders.jobTitle": "Role",
    "placeholders.company": "Company",
    "placeholders.degree": "Degree",
    "placeholders.school": "School",
    "placeholders.skill": "Kubernetes",
    "placeholders.noName": "Your Name",
    "placeholders.noTitle": "Your Professional Title",
    "placeholders.present": "Present",
    "levels.beginner": "Beginner",
    "levels.intermediate": "Intermediate",
    "levels.advanced": "Advanced",
    "levels.expert": "Expert",
    "privacy.title": "Privacy Policy",
    "privacy.intro": "Free Resume is a static, client-side application. Your privacy is our priority.",
    "privacy.noCollection": "No personal data collected",
    "privacy.noCollectionDetail": "This application does not collect, transmit, or process any personal data. All resume content you enter stays entirely within your browser.",
    "privacy.localStorage": "Local storage only",
    "privacy.localStorageDetail": "Your resume draft is saved to your browser's localStorage so you can continue editing later. This data never leaves your device. You can clear it at any time through your browser settings.",
    "privacy.hosting": "Hosting",
    "privacy.hostingDetail": "This site is hosted on GitHub Pages. GitHub may collect technical information such as your IP address in server logs. See GitHub's privacy statement for details.",
    "privacy.noCookies": "No cookies",
    "privacy.noCookiesDetail": "This application does not set or read any cookies.",
    "privacy.noThirdParty": "No third-party services",
    "privacy.noThirdPartyDetail": "All fonts and assets are self-hosted. No external requests are made when you use this application.",
    "privacy.retention": "Data retention",
    "privacy.retentionDetail": "Your resume data remains in your browser's localStorage until you manually clear it through your browser settings. No data is retained on any server by the site operator.",
    "privacy.rights": "Your rights",
    "privacy.rightsDetail": "Under the General Data Protection Regulation (GDPR), you have the right to access, rectify, erase, restrict processing, port, and object to the processing of your personal data. Since all data is stored locally in your browser and never transmitted to us, you can exercise these rights directly by clearing your browser's localStorage or site data at any time.",
    "privacy.controller": "Data controller",
    "privacy.controllerDetail": "This site is operated and maintained by its developer as a free, open-source project. If you have privacy-related questions, you can open an issue on the project's GitHub repository.",
    "privacy.complaint": "Right to lodge a complaint",
    "privacy.complaintDetail": "If you believe your data protection rights have been violated, you have the right to lodge a complaint with a supervisory authority in the EU member state of your habitual residence, place of work, or place of the alleged infringement.",
    "privacy.lastUpdated": "Last updated: February 2026",
    "privacy.footer": "Privacy",
    "privacy.close": "Close"
  },
  es: {
    "brand.title": "Free Resume",
    "brand.subtitle": "Constructor de curriculums moderno y multilingue",
    "fields.template": "Plantilla",
    "fields.showSkills": "Mostrar seccion de habilidades",
    "fields.identity": "Identidad",
    "fields.fullName": "Nombre completo",
    "fields.headline": "Titulo profesional",
    "fields.email": "Correo",
    "fields.phone": "Telefono",
    "fields.location": "Ubicacion",
    "fields.website": "Sitio web",
    "fields.linkedin": "LinkedIn",
    "fields.github": "GitHub",
    "fields.summary": "Resumen",
    "fields.summaryHint": "Escribe una breve presentacion profesional.",
    "fields.experience": "Experiencia",
    "fields.education": "Educacion",
    "fields.skills": "Habilidades",
    "fields.jobTitle": "Puesto",
    "fields.company": "Empresa",
    "fields.itemLocation": "Ubicacion",
    "fields.startDate": "Inicio",
    "fields.endDate": "Fin",
    "fields.highlights": "Logros (uno por linea)",
    "fields.degree": "Titulo academico",
    "fields.school": "Institucion",
    "fields.skillName": "Habilidad",
    "fields.skillLevel": "Nivel",
    "fields.showSkillLevel": "Mostrar nivel de habilidad",
    "fields.cvLanguage": "Idioma del CV",
    "actions.darkMode": "Modo oscuro",
    "actions.lightMode": "Modo claro",
    "actions.addExperience": "Agregar experiencia",
    "actions.addEducation": "Agregar educacion",
    "actions.addSkill": "Agregar habilidad",
    "actions.remove": "Eliminar",
    "actions.uploadRaw": "Subir CV raw",
    "actions.downloadRaw": "Descargar CV raw",
    "actions.pdf": "Guardar PDF",
    "errors.invalidRawFile": "No se pudo importar el archivo. Elige un JSON valido de Free Resume.",
    "templates.berlin": "Clasica Berlin",
    "templates.aurora": "Linea de tiempo Aurora",
    "templates.atelier": "Cuadricula Atelier",
    "templates.noir": "Noir Minimal",
    "templates.fjord": "Division Fjord",
    "templates.solstice": "Banner Solstice",
    "templates.bastion": "Registro Bastion",
    "templates.slate": "Slate Mono",
    "templates.kernel": "Sistemas Kernel",
    "templates.alpine": "Clasica Alpine",
    "preview.live": "Vista previa",
    "preview.blank": "Comienza en blanco",
    "sections.summary": "Perfil",
    "sections.experience": "Historial laboral",
    "sections.education": "Educacion",
    "sections.skills": "Habilidades",
    "sections.details": "Detalles",
    "sections.links": "Enlaces",
    "empty.resumeStart": "Tu curriculum comienza en blanco. Agrega contenido desde el editor.",
    "empty.experience": "Agrega tu primera experiencia.",
    "empty.education": "Agrega tu historial academico.",
    "empty.skills": "Agrega habilidades para destacar tus fortalezas.",
    "empty.experienceEditor": "Aun no hay experiencias.",
    "empty.educationEditor": "Aun no hay educacion.",
    "empty.skillsEditor": "Aun no hay habilidades.",
    "placeholders.name": "Juan Perez",
    "placeholders.title": "Tu Titulo Profesional",
    "placeholders.email": "nombre@ejemplo.com",
    "placeholders.phone": "+34 600 000000",
    "placeholders.location": "Madrid, Espana",
    "placeholders.website": "tuweb.dev",
    "placeholders.linkedin": "linkedin.com/in/usuario",
    "placeholders.github": "github.com/usuario",
    "placeholders.summary": "Ingeniero de infraestructura con enfoque en automatizacion...",
    "placeholders.jobTitle": "Puesto",
    "placeholders.company": "Empresa",
    "placeholders.degree": "Titulo",
    "placeholders.school": "Institucion",
    "placeholders.skill": "Kubernetes",
    "placeholders.noName": "Tu Nombre",
    "placeholders.noTitle": "Tu Titulo Profesional",
    "placeholders.present": "Actual",
    "levels.beginner": "Principiante",
    "levels.intermediate": "Intermedio",
    "levels.advanced": "Avanzado",
    "levels.expert": "Experto",
    "privacy.title": "Politica de privacidad",
    "privacy.intro": "Free Resume es una aplicacion estatica que se ejecuta en el navegador. Tu privacidad es nuestra prioridad.",
    "privacy.noCollection": "No se recopilan datos personales",
    "privacy.noCollectionDetail": "Esta aplicacion no recopila, transmite ni procesa datos personales. Todo el contenido de tu curriculum permanece en tu navegador.",
    "privacy.localStorage": "Solo almacenamiento local",
    "privacy.localStorageDetail": "Tu borrador se guarda en el localStorage del navegador para que puedas continuar editando. Estos datos nunca salen de tu dispositivo. Puedes eliminarlos desde la configuracion de tu navegador.",
    "privacy.hosting": "Alojamiento",
    "privacy.hostingDetail": "Este sitio esta alojado en GitHub Pages. GitHub puede registrar informacion tecnica como tu direccion IP. Consulta la declaracion de privacidad de GitHub para mas detalles.",
    "privacy.noCookies": "Sin cookies",
    "privacy.noCookiesDetail": "Esta aplicacion no utiliza ni lee cookies.",
    "privacy.noThirdParty": "Sin servicios de terceros",
    "privacy.noThirdPartyDetail": "Todas las fuentes y recursos se alojan localmente. No se realizan solicitudes externas al usar esta aplicacion.",
    "privacy.retention": "Retencion de datos",
    "privacy.retentionDetail": "Los datos de tu curriculum permanecen en el localStorage de tu navegador hasta que los elimines manualmente desde la configuracion del navegador. El operador del sitio no retiene datos en ningun servidor.",
    "privacy.rights": "Tus derechos",
    "privacy.rightsDetail": "Segun el Reglamento General de Proteccion de Datos (RGPD), tienes derecho a acceder, rectificar, eliminar, limitar el tratamiento, portar y oponerte al tratamiento de tus datos personales. Dado que todos los datos se almacenan localmente en tu navegador y nunca se transmiten, puedes ejercer estos derechos directamente borrando el localStorage o los datos del sitio en tu navegador en cualquier momento.",
    "privacy.controller": "Responsable del tratamiento",
    "privacy.controllerDetail": "Este sitio es operado y mantenido por su desarrollador como un proyecto gratuito y de codigo abierto. Si tienes preguntas sobre privacidad, puedes abrir un issue en el repositorio de GitHub del proyecto.",
    "privacy.complaint": "Derecho a presentar una reclamacion",
    "privacy.complaintDetail": "Si consideras que se han vulnerado tus derechos de proteccion de datos, tienes derecho a presentar una reclamacion ante una autoridad de control en el Estado miembro de la UE de tu residencia habitual, lugar de trabajo o lugar de la presunta infraccion.",
    "privacy.lastUpdated": "Ultima actualizacion: febrero de 2026",
    "privacy.footer": "Privacidad",
    "privacy.close": "Cerrar"
  },
  de: {
    "brand.title": "Free Resume",
    "brand.subtitle": "Moderner mehrsprachiger Lebenslauf-Builder",
    "fields.template": "Vorlage",
    "fields.showSkills": "Skill-Bereich anzeigen",
    "fields.identity": "Identitat",
    "fields.fullName": "Vollstandiger Name",
    "fields.headline": "Berufsbezeichnung",
    "fields.email": "E-Mail",
    "fields.phone": "Telefon",
    "fields.location": "Ort",
    "fields.website": "Webseite",
    "fields.linkedin": "LinkedIn",
    "fields.github": "GitHub",
    "fields.summary": "Zusammenfassung",
    "fields.summaryHint": "Schreibe eine kurze professionelle Zusammenfassung.",
    "fields.experience": "Erfahrung",
    "fields.education": "Ausbildung",
    "fields.skills": "Skills",
    "fields.jobTitle": "Position",
    "fields.company": "Unternehmen",
    "fields.itemLocation": "Ort",
    "fields.startDate": "Start",
    "fields.endDate": "Ende",
    "fields.highlights": "Highlights (eine Zeile pro Punkt)",
    "fields.degree": "Abschluss",
    "fields.school": "Schule / Universitat",
    "fields.skillName": "Skill",
    "fields.skillLevel": "Level",
    "fields.showSkillLevel": "Skill-Level anzeigen",
    "fields.cvLanguage": "CV-Sprache",
    "actions.darkMode": "Dunkelmodus",
    "actions.lightMode": "Hellmodus",
    "actions.addExperience": "Erfahrung hinzufugen",
    "actions.addEducation": "Ausbildung hinzufugen",
    "actions.addSkill": "Skill hinzufugen",
    "actions.remove": "Entfernen",
    "actions.uploadRaw": "Raw-CV hochladen",
    "actions.downloadRaw": "Raw-CV herunterladen",
    "actions.pdf": "Als PDF speichern",
    "errors.invalidRawFile": "Datei konnte nicht importiert werden. Bitte eine gultige Free Resume JSON-Datei auswahlen.",
    "templates.berlin": "Berlin Klassisch",
    "templates.aurora": "Aurora Zeitleiste",
    "templates.atelier": "Atelier Raster",
    "templates.noir": "Noir Minimal",
    "templates.fjord": "Fjord Teilung",
    "templates.solstice": "Solstice Banner",
    "templates.bastion": "Bastion Ledger",
    "templates.slate": "Slate Mono",
    "templates.kernel": "Kernel Systeme",
    "templates.alpine": "Alpine Klassisch",
    "preview.live": "Live-Vorschau",
    "preview.blank": "Startet leer",
    "sections.summary": "Profil",
    "sections.experience": "Berufserfahrung",
    "sections.education": "Ausbildung",
    "sections.skills": "Skills",
    "sections.details": "Details",
    "sections.links": "Links",
    "empty.resumeStart": "Dein Lebenslauf startet leer. Inhalte im Editor hinzufugen.",
    "empty.experience": "Fuge deinen ersten Erfahrungs-Eintrag hinzu.",
    "empty.education": "Fuge deine Ausbildung hinzu.",
    "empty.skills": "Fuge Skills hinzu, um deine Starken zu zeigen.",
    "empty.experienceEditor": "Noch keine Erfahrungseintrage.",
    "empty.educationEditor": "Noch keine Ausbildungseintrage.",
    "empty.skillsEditor": "Noch keine Skills hinzugefugt.",
    "placeholders.name": "Max Mustermann",
    "placeholders.title": "Deine Berufsbezeichnung",
    "placeholders.email": "name@beispiel.de",
    "placeholders.phone": "+49 000 000000",
    "placeholders.location": "Berlin, Deutschland",
    "placeholders.website": "deineseite.dev",
    "placeholders.linkedin": "linkedin.com/in/username",
    "placeholders.github": "github.com/username",
    "placeholders.summary": "Infrastruktur-Ingenieur mit starkem Fokus auf Automatisierung...",
    "placeholders.jobTitle": "Position",
    "placeholders.company": "Unternehmen",
    "placeholders.degree": "Abschluss",
    "placeholders.school": "Institution",
    "placeholders.skill": "Kubernetes",
    "placeholders.noName": "Dein Name",
    "placeholders.noTitle": "Deine Berufsbezeichnung",
    "placeholders.present": "Heute",
    "levels.beginner": "Grundlagen",
    "levels.intermediate": "Fortgeschritten",
    "levels.advanced": "Sehr gut",
    "levels.expert": "Experte",
    "privacy.title": "Datenschutzerklarung",
    "privacy.intro": "Free Resume ist eine statische, clientseitige Anwendung. Dein Datenschutz hat fur uns Prioritat.",
    "privacy.noCollection": "Keine personenbezogenen Daten erhoben",
    "privacy.noCollectionDetail": "Diese Anwendung erhebt, ubertragt oder verarbeitet keine personenbezogenen Daten. Alle Lebenslauf-Inhalte bleiben vollstandig in deinem Browser.",
    "privacy.localStorage": "Nur lokale Speicherung",
    "privacy.localStorageDetail": "Dein Entwurf wird im localStorage des Browsers gespeichert, damit du spater weiterarbeiten kannst. Diese Daten verlassen dein Gerat nie. Du kannst sie jederzeit uber die Browser-Einstellungen loschen.",
    "privacy.hosting": "Hosting",
    "privacy.hostingDetail": "Diese Seite wird auf GitHub Pages gehostet. GitHub kann technische Informationen wie deine IP-Adresse in Server-Logs erfassen. Siehe GitHubs Datenschutzerklarung fur Details.",
    "privacy.noCookies": "Keine Cookies",
    "privacy.noCookiesDetail": "Diese Anwendung setzt und liest keine Cookies.",
    "privacy.noThirdParty": "Keine Drittanbieterdienste",
    "privacy.noThirdPartyDetail": "Alle Schriftarten und Ressourcen sind lokal gehostet. Bei der Nutzung dieser Anwendung werden keine externen Anfragen gestellt.",
    "privacy.retention": "Datenspeicherung",
    "privacy.retentionDetail": "Deine Lebenslauf-Daten verbleiben im localStorage deines Browsers, bis du sie manuell uber die Browser-Einstellungen loschst. Der Seitenbetreiber speichert keine Daten auf einem Server.",
    "privacy.rights": "Deine Rechte",
    "privacy.rightsDetail": "Gemaess der Datenschutz-Grundverordnung (DSGVO) hast du das Recht auf Auskunft, Berichtigung, Loschung, Einschrankung der Verarbeitung, Datenubertragbarkeit und Widerspruch gegen die Verarbeitung deiner personenbezogenen Daten. Da alle Daten lokal in deinem Browser gespeichert und nie an uns ubermittelt werden, kannst du diese Rechte jederzeit ausuben, indem du den localStorage oder die Websitedaten in deinem Browser loschst.",
    "privacy.controller": "Verantwortlicher",
    "privacy.controllerDetail": "Diese Seite wird von ihrem Entwickler als kostenloses Open-Source-Projekt betrieben und gepflegt. Bei Fragen zum Datenschutz kannst du ein Issue im GitHub-Repository des Projekts erstellen.",
    "privacy.complaint": "Beschwerderecht",
    "privacy.complaintDetail": "Wenn du der Meinung bist, dass deine Datenschutzrechte verletzt wurden, hast du das Recht, eine Beschwerde bei einer Aufsichtsbehorde im EU-Mitgliedstaat deines gewohnlichen Aufenthaltsorts, deines Arbeitsplatzes oder des Orts des mutmasslichen Verstosses einzureichen.",
    "privacy.lastUpdated": "Letzte Aktualisierung: Februar 2026",
    "privacy.footer": "Datenschutz",
    "privacy.close": "Schliessen"
  }
};

const skillLevels = ["beginner", "intermediate", "advanced", "expert"];

const state = {
  uiLang: "en",
  cvLang: "en",
  template: "berlin",
  theme: window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light",
  showSkills: false,
  profile: {
    name: "",
    title: "",
    email: "",
    phone: "",
    location: "",
    website: "",
    linkedin: "",
    github: ""
  },
  summary: "",
  experience: [],
  education: [],
  skills: []
};

const refs = {
  templateSelect: document.getElementById("template-select"),
  themeToggle: document.getElementById("theme-toggle"),
  downloadRawBtn: document.getElementById("download-raw-btn"),
  uploadRawBtn: document.getElementById("upload-raw-btn"),
  sampleBtn: document.getElementById("sample-btn"),
  rawFileInput: document.getElementById("raw-file-input"),
  resumePreview: document.getElementById("resume-preview"),
  previewPanel: document.querySelector(".preview-panel"),
  experienceList: document.getElementById("experience-list"),
  educationList: document.getElementById("education-list"),
  skillsList: document.getElementById("skills-list"),
  blankPill: document.getElementById("blank-pill"),
  editorPanel: document.querySelector(".editor-panel"),
  privacyModal: document.getElementById("privacy-modal")
};

let sampleModeEnabled = false;

function tUI(key) {
  return translations[state.uiLang]?.[key] ?? translations.en[key] ?? key;
}

function tCV(key) {
  return translations[state.cvLang]?.[key] ?? translations.en[key] ?? key;
}

function t(key) {
  return tUI(key);
}

function escapeHtml(value) {
  return String(value ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}

function escapeAttr(value) {
  return escapeHtml(value).replaceAll("`", "&#96;");
}

function formatTextBlock(value) {
  return escapeHtml(value).replace(/\n/g, "<br />");
}

function hasText(value) {
  return String(value ?? "").trim().length > 0;
}

function hasObjectContent(item) {
  return Object.values(item).some(hasText);
}

function normalizeSkillLevel(level) {
  return skillLevels.includes(level) ? level : "intermediate";
}

function createResumeFilename() {
  const profileName = String(state.profile.name ?? "")
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");

  return profileName ? `${profileName}-resume` : "resume";
}

function openPdfDialog() {
  const previousTitle = document.title;
  document.title = createResumeFilename();
  window.print();
  document.title = previousTitle;
}

function normalizeUrl(raw) {
  const value = String(raw ?? "").trim();

  if (!value) {
    return "";
  }

  if (/^(https?:|mailto:|tel:)/i.test(value)) {
    return value;
  }

  if (/^[\w.-]+@[\w.-]+\.[A-Za-z]{2,}$/.test(value)) {
    return `mailto:${value}`;
  }

  if (/^[+()\d\s-]{6,}$/.test(value)) {
    return `tel:${value.replace(/\s+/g, "")}`;
  }

  if (/^[\w.-]+\.[A-Za-z]{2,}/.test(value)) {
    return `https://${value}`;
  }

  return "";
}

function buildLink(value) {
  const cleaned = String(value ?? "").trim();

  if (!cleaned) {
    return "";
  }

  const href = normalizeUrl(cleaned);
  if (!href) {
    return `<span>${escapeHtml(cleaned)}</span>`;
  }

  return `<a href="${escapeAttr(href)}" target="_blank" rel="noreferrer">${escapeHtml(cleaned)}</a>`;
}

function formatRange(start, end) {
  const cleanStart = String(start ?? "").trim();
  const cleanEnd = String(end ?? "").trim();

  if (!cleanStart && !cleanEnd) {
    return "";
  }

  if (cleanStart && cleanEnd) {
    return `${cleanStart} - ${cleanEnd}`;
  }

  if (cleanStart) {
    return `${cleanStart} - ${tCV("placeholders.present")}`;
  }

  return cleanEnd;
}

function getSummaryMarkup() {
  return hasText(state.summary) ? `<p>${formatTextBlock(state.summary)}</p>` : "";
}

function getExperienceItems() {
  return state.experience.filter((item) => hasObjectContent(item));
}

function getEducationItems() {
  return state.education.filter((item) => hasObjectContent(item));
}

function getSkillItems() {
  return state.skills
    .map((item) => ({
      name: String(item.name ?? "").trim(),
      level: normalizeSkillLevel(item.level),
      showLevel: toBoolean(item.showLevel, false)
    }))
    .filter((item) => hasText(item.name));
}

function renderExperienceEntries() {
  const entries = getExperienceItems();

  if (!entries.length) {
    return "";
  }

  return entries
    .map((item) => {
      const role = hasText(item.role) ? item.role : tCV("placeholders.jobTitle");
      const companyLocation = [item.company, item.location].filter(hasText).join(" 路 ");
      const bullets = String(item.bullets ?? "")
        .split("\n")
        .map((line) => line.trim())
        .filter(Boolean);

      return `
        <article class="entry">
          <div class="entry-topline">
            <h4 class="entry-title">${escapeHtml(role)}</h4>
            <span class="entry-meta">${escapeHtml(formatRange(item.start, item.end))}</span>
          </div>
          ${companyLocation ? `<p class="entry-company">${escapeHtml(companyLocation)}</p>` : ""}
          ${bullets.length ? `<ul>${bullets.map((point) => `<li>${escapeHtml(point)}</li>`).join("")}</ul>` : ""}
        </article>
      `;
    })
    .join("");
}

function renderEducationEntries() {
  const entries = getEducationItems();

  if (!entries.length) {
    return "";
  }

  return entries
    .map((item) => {
      const degree = hasText(item.degree) ? item.degree : tCV("placeholders.degree");
      const schoolLocation = [item.school, item.location].filter(hasText).join(" 路 ");

      return `
        <article class="entry">
          <div class="entry-topline">
            <h4 class="entry-title">${escapeHtml(degree)}</h4>
            <span class="entry-meta">${escapeHtml(formatRange(item.start, item.end))}</span>
          </div>
          ${schoolLocation ? `<p class="entry-company">${escapeHtml(schoolLocation)}</p>` : ""}
        </article>
      `;
    })
    .join("");
}

function renderSkillsMarkup() {
  const skills = getSkillItems();

  if (!skills.length) {
    return "";
  }

  return `
    <div class="skill-cloud">
      ${skills
        .map((skill) => {
          const levelMarkup = skill.showLevel
            ? `<span class="skill-chip-level">${tCV(`levels.${skill.level}`)}</span>`
            : "";

          return `<span class="skill-chip"><span>${escapeHtml(skill.name)}</span>${levelMarkup}</span>`;
        })
        .join("")}
    </div>
  `;
}

function renderBerlinTemplate() {
  const name = hasText(state.profile.name) ? state.profile.name : tCV("placeholders.noName");
  const title = hasText(state.profile.title) ? state.profile.title : tCV("placeholders.noTitle");
  const summaryMarkup = getSummaryMarkup();
  const experienceMarkup = renderExperienceEntries();
  const educationMarkup = renderEducationEntries();
  const skillsMarkup = renderSkillsMarkup();

  const detailsList = [
    state.profile.email ? `<li>${buildLink(state.profile.email)}</li>` : "",
    state.profile.phone ? `<li>${buildLink(state.profile.phone)}</li>` : "",
    state.profile.location ? `<li>${escapeHtml(state.profile.location)}</li>` : ""
  ]
    .filter(Boolean)
    .join("");

  const linksList = [state.profile.website, state.profile.linkedin, state.profile.github]
    .filter(hasText)
    .map((value) => `<li>${buildLink(value)}</li>`)
    .join("");

  const mainSections = [
    summaryMarkup ? `<section><h3 class="section-label">${tCV("sections.summary")}</h3>${summaryMarkup}</section>` : "",
    experienceMarkup
      ? `<section><h3 class="section-label">${tCV("sections.experience")}</h3>${experienceMarkup}</section>`
      : "",
    educationMarkup ? `<section><h3 class="section-label">${tCV("sections.education")}</h3>${educationMarkup}</section>` : ""
  ]
    .filter(Boolean)
    .join("");

  const sidebarSections = [
    detailsList ? `<section><h3 class="section-label">${tCV("sections.details")}</h3><ul class="details-list">${detailsList}</ul></section>` : "",
    linksList ? `<section><h3 class="section-label">${tCV("sections.links")}</h3><ul class="links-list">${linksList}</ul></section>` : "",
    skillsMarkup ? `<section><h3 class="section-label">${tCV("sections.skills")}</h3>${skillsMarkup}</section>` : ""
  ]
    .filter(Boolean)
    .join("");

  return `
    <article class="resume-page">
      <header class="resume-header">
        <h1 class="resume-name">${escapeHtml(name)}</h1>
        <p class="resume-role">${escapeHtml(title)}</p>
      </header>

      <div class="resume-columns${mainSections && sidebarSections ? "" : " single-column"}">
        ${mainSections ? `<div>${mainSections}</div>` : ""}
        ${sidebarSections ? `<aside>${sidebarSections}</aside>` : ""}
      </div>
    </article>
  `;
}

function renderAuroraTemplate() {
  const name = hasText(state.profile.name) ? state.profile.name : tCV("placeholders.noName");
  const title = hasText(state.profile.title) ? state.profile.title : tCV("placeholders.noTitle");
  const summaryMarkup = getSummaryMarkup();
  const skillsMarkup = renderSkillsMarkup();

  const details = [state.profile.email, state.profile.phone, state.profile.location]
    .filter(hasText)
    .map((value) => `<li>${buildLink(value)}</li>`)
    .join("");

  const links = [state.profile.website, state.profile.linkedin, state.profile.github]
    .filter(hasText)
    .map((value) => `<li>${buildLink(value)}</li>`)
    .join("");

  const experienceEntries = getExperienceItems();
  const educationEntries = getEducationItems();

  const sideSections = [
    summaryMarkup ? `<section><h3 class="section-label">${tCV("sections.summary")}</h3>${summaryMarkup}</section>` : "",
    details ? `<section><h3 class="section-label">${tCV("sections.details")}</h3><ul>${details}</ul></section>` : "",
    links ? `<section><h3 class="section-label">${tCV("sections.links")}</h3><ul>${links}</ul></section>` : "",
    skillsMarkup ? `<section><h3 class="section-label">${tCV("sections.skills")}</h3>${skillsMarkup}</section>` : ""
  ]
    .filter(Boolean)
    .join("");

  const mainSections = [
    experienceEntries.length
      ? `<section>
            <h3 class="section-label">${tCV("sections.experience")}</h3>
            <ul class="timeline">${experienceEntries
              .map((item) => {
                const role = hasText(item.role) ? item.role : tCV("placeholders.jobTitle");
                const meta = [item.company, item.location].filter(hasText).join(" 路 ");
                const bullets = String(item.bullets ?? "")
                  .split("\n")
                  .map((line) => line.trim())
                  .filter(Boolean);

                return `
                        <li>
                          <div class="entry-topline">
                            <h4 class="entry-title">${escapeHtml(role)}</h4>
                            <span class="entry-meta">${escapeHtml(formatRange(item.start, item.end))}</span>
                          </div>
                          ${meta ? `<p class="entry-company">${escapeHtml(meta)}</p>` : ""}
                          ${bullets.length ? `<ul>${bullets.map((line) => `<li>${escapeHtml(line)}</li>`).join("")}</ul>` : ""}
                        </li>
                      `;
              })
              .join("")}</ul>
          </section>`
      : "",
    educationEntries.length
      ? `<section>
            <h3 class="section-label">${tCV("sections.education")}</h3>
            ${educationEntries
              .map((item) => {
                const degree = hasText(item.degree) ? item.degree : tCV("placeholders.degree");
                const meta = [item.school, item.location].filter(hasText).join(" 路 ");

                return `
                        <article class="entry">
                          <div class="entry-topline">
                            <h4 class="entry-title">${escapeHtml(degree)}</h4>
                            <span class="entry-meta">${escapeHtml(formatRange(item.start, item.end))}</span>
                          </div>
                          ${meta ? `<p class="entry-company">${escapeHtml(meta)}</p>` : ""}
                        </article>
                      `;
              })
              .join("")}
          </section>`
      : ""
  ]
    .filter(Boolean)
    .join("");

  return `
    <article class="resume-page">
      <header class="aurora-banner">
        <h1 class="aurora-name">${escapeHtml(name)}</h1>
        <p class="aurora-role">${escapeHtml(title)}</p>
      </header>

      <div class="aurora-shell${sideSections && mainSections ? "" : " single-pane"}">
        ${sideSections ? `<aside class="aurora-side">${sideSections}</aside>` : ""}
        ${mainSections ? `<div class="aurora-main">${mainSections}</div>` : ""}
      </div>
    </article>
  `;
}

function renderAlpineTemplate() {
  const name = hasText(state.profile.name) ? state.profile.name : tCV("placeholders.noName");
  const title = hasText(state.profile.title) ? state.profile.title : tCV("placeholders.noTitle");
  const location = state.profile.location;
  const summaryMarkup = getSummaryMarkup();
  const experienceMarkup = renderExperienceEntries();
  const educationMarkup = renderEducationEntries();

  const metaParts = [
    escapeHtml(title),
    hasText(location)
      ? `<span class="alpine-pin"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> ${escapeHtml(location)}</span>`
      : ""
  ].filter(Boolean).join("&nbsp;&nbsp;&nbsp;");

  const detailsList = [
    state.profile.location ? `<li>${escapeHtml(state.profile.location)}</li>` : "",
    state.profile.email ? `<li>${buildLink(state.profile.email)}</li>` : "",
    state.profile.phone ? `<li>${buildLink(state.profile.phone)}</li>` : ""
  ].filter(Boolean).join("");

  const linksList = [state.profile.website, state.profile.linkedin, state.profile.github]
    .filter(hasText)
    .map((value) => `<li>${buildLink(value)}</li>`)
    .join("");

  const skills = getSkillItems();
  const skillsList = skills.length
    ? `<ul class="alpine-skills">${skills.map((s) => `<li>${escapeHtml(s.name)}</li>`).join("")}</ul>`
    : "";

  const sidebarSections = [
    detailsList ? `<section><h3 class="alpine-dot-heading">${tCV("sections.details")}</h3><ul class="alpine-details">${detailsList}</ul></section>` : "",
    linksList ? `<section><h3 class="alpine-dot-heading">${tCV("sections.links")}</h3><ul class="alpine-links">${linksList}</ul></section>` : "",
    skillsList ? `<section><h3 class="alpine-dot-heading">${tCV("sections.skills")}</h3>${skillsList}</section>` : ""
  ].filter(Boolean).join("");

  const iconProfile = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
  const iconWork = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>`;
  const iconEdu = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 1.1 2.7 3 6 3s6-1.9 6-3v-5"/></svg>`;

  const mainSections = [
    summaryMarkup ? `<section><h3 class="alpine-icon-heading">${iconProfile} ${tCV("sections.summary")}</h3>${summaryMarkup}</section>` : "",
    experienceMarkup ? `<section><h3 class="alpine-icon-heading">${iconWork} ${tCV("sections.experience")}</h3>${experienceMarkup}</section>` : "",
    educationMarkup ? `<section><h3 class="alpine-icon-heading">${iconEdu} ${tCV("sections.education")}</h3>${educationMarkup}</section>` : ""
  ].filter(Boolean).join("");

  return `
    <article class="resume-page">
      <header class="alpine-header">
        <h1 class="alpine-name">${escapeHtml(name)}</h1>
        <p class="alpine-meta">${metaParts}</p>
      </header>
      <div class="alpine-body${sidebarSections && mainSections ? "" : " alpine-single"}">
        ${sidebarSections ? `<aside class="alpine-sidebar">${sidebarSections}</aside>` : ""}
        ${mainSections ? `<div class="alpine-main">${mainSections}</div>` : ""}
      </div>
    </article>
  `;
}

function renderAtelierTemplate() {
  const name = hasText(state.profile.name) ? state.profile.name : tCV("placeholders.noName");
  const title = hasText(state.profile.title) ? state.profile.title : tCV("placeholders.noTitle");
  const summaryMarkup = getSummaryMarkup();
  const experienceMarkup = renderExperienceEntries();
  const educationMarkup = renderEducationEntries();
  const skillsMarkup = renderSkillsMarkup();

  const links = [state.profile.website, state.profile.linkedin, state.profile.github]
    .filter(hasText)
    .map((value) => `<li>${buildLink(value)}</li>`)
    .join("");

  const details = [state.profile.email, state.profile.phone, state.profile.location]
    .filter(hasText)
    .map((value) => `<li>${buildLink(value)}</li>`)
    .join("");

  const mainCards = [
    summaryMarkup ? `<section class="card"><h3 class="section-label">${tCV("sections.summary")}</h3>${summaryMarkup}</section>` : "",
    experienceMarkup
      ? `<section class="card"><h3 class="section-label">${tCV("sections.experience")}</h3>${experienceMarkup}</section>`
      : "",
    educationMarkup ? `<section class="card"><h3 class="section-label">${tCV("sections.education")}</h3>${educationMarkup}</section>` : ""
  ]
    .filter(Boolean)
    .join("");

  const sideCards = [
    details ? `<section class="card"><h3 class="section-label">${tCV("sections.details")}</h3><ul>${details}</ul></section>` : "",
    links ? `<section class="card"><h3 class="section-label">${tCV("sections.links")}</h3><ul>${links}</ul></section>` : "",
    skillsMarkup ? `<section class="card"><h3 class="section-label">${tCV("sections.skills")}</h3>${skillsMarkup}</section>` : ""
  ]
    .filter(Boolean)
    .join("");

  return `
    <article class="resume-page">
      <header class="atelier-head">
        <h1 class="atelier-name">${escapeHtml(name)}</h1>
        <p class="atelier-role">${escapeHtml(title)}</p>
      </header>

      <div class="atelier-grid${mainCards && sideCards ? "" : " single-column"}">
        ${mainCards ? `<div>${mainCards}</div>` : ""}
        ${sideCards ? `<aside>${sideCards}</aside>` : ""}
      </div>
    </article>
  `;
}

const templateCatalog = {
  berlin: {
    render: renderBerlinTemplate,
    baseClass: "template-berlin"
  },
  aurora: {
    render: renderAuroraTemplate,
    baseClass: "template-aurora"
  },
  atelier: {
    render: renderAtelierTemplate,
    baseClass: "template-atelier"
  },
  noir: {
    render: renderBerlinTemplate,
    baseClass: "template-berlin",
    variantClass: "variant-noir"
  },
  fjord: {
    render: renderBerlinTemplate,
    baseClass: "template-berlin",
    variantClass: "variant-fjord"
  },
  solstice: {
    render: renderAuroraTemplate,
    baseClass: "template-aurora",
    variantClass: "variant-solstice"
  },
  bastion: {
    render: renderAuroraTemplate,
    baseClass: "template-aurora",
    variantClass: "variant-bastion"
  },
  slate: {
    render: renderBerlinTemplate,
    baseClass: "template-berlin",
    variantClass: "variant-slate"
  },
  kernel: {
    render: renderBerlinTemplate,
    baseClass: "template-berlin",
    variantClass: "variant-kernel"
  },
  alpine: {
    render: renderAlpineTemplate,
    baseClass: "template-alpine"
  }
};

const rawExportConfig = {
  app: "free-resume",
  schemaVersion: 2
};

const localDraftConfig = {
  key: "free-resume:draft"
};

function toInputText(value) {
  if (typeof value === "string") {
    return value;
  }

  if (typeof value === "number") {
    return String(value);
  }

  return "";
}

function toBoolean(value, fallback = false) {
  if (typeof value === "boolean") {
    return value;
  }

  if (typeof value === "number") {
    return value !== 0;
  }

  if (typeof value === "string") {
    const normalized = value.trim().toLowerCase();

    if (["true", "1", "yes", "on"].includes(normalized)) {
      return true;
    }

    if (["false", "0", "no", "off"].includes(normalized)) {
      return false;
    }
  }

  return fallback;
}

function sanitizeExperienceItem(item) {
  return {
    role: toInputText(item?.role),
    company: toInputText(item?.company),
    location: toInputText(item?.location),
    start: toInputText(item?.start),
    end: toInputText(item?.end),
    bullets: toInputText(item?.bullets)
  };
}

function sanitizeEducationItem(item) {
  return {
    degree: toInputText(item?.degree),
    school: toInputText(item?.school),
    location: toInputText(item?.location),
    start: toInputText(item?.start),
    end: toInputText(item?.end)
  };
}

function sanitizeSkillItem(item) {
  const source = item && typeof item === "object" ? item : { name: item };

  return {
    name: toInputText(source?.name),
    level: normalizeSkillLevel(source?.level),
    showLevel: toBoolean(source?.showLevel, false)
  };
}

function sanitizeResumeState(rawState) {
  const source = rawState && typeof rawState === "object" ? rawState : {};
  const profileSource = source.profile && typeof source.profile === "object" ? source.profile : {};
  const fallbackLang = Object.prototype.hasOwnProperty.call(translations, source.lang) ? source.lang : "en";
  const uiLang = Object.prototype.hasOwnProperty.call(translations, source.uiLang) ? source.uiLang : fallbackLang;
  const cvLang = Object.prototype.hasOwnProperty.call(translations, source.cvLang) ? source.cvLang : fallbackLang;

  return {
    lang: uiLang,
    uiLang,
    cvLang,
    template: typeof source.template === "string" && templateCatalog[source.template] ? source.template : "berlin",
    theme: source.theme === "dark" ? "dark" : "light",
    showSkills: Boolean(source.showSkills),
    profile: {
      name: toInputText(profileSource.name),
      title: toInputText(profileSource.title),
      email: toInputText(profileSource.email),
      phone: toInputText(profileSource.phone),
      location: toInputText(profileSource.location),
      website: toInputText(profileSource.website),
      linkedin: toInputText(profileSource.linkedin),
      github: toInputText(profileSource.github)
    },
    summary: toInputText(source.summary),
    experience: Array.isArray(source.experience) ? source.experience.map((item) => sanitizeExperienceItem(item)) : [],
    education: Array.isArray(source.education) ? source.education.map((item) => sanitizeEducationItem(item)) : [],
    skills: Array.isArray(source.skills) ? source.skills.map((item) => sanitizeSkillItem(item)) : []
  };
}

function parseRawResumePayload(payload) {
  if (!payload || typeof payload !== "object") {
    return null;
  }

  if (typeof payload.app === "string" && payload.app !== rawExportConfig.app) {
    return null;
  }

  const source =
    payload.data && typeof payload.data === "object"
      ? payload.data
      : payload.resume && typeof payload.resume === "object"
        ? payload.resume
        : payload;

  const hasExpectedShape = ["profile", "summary", "experience", "education", "skills", "template"].some(
    (key) => key in source
  );

  if (!hasExpectedShape) {
    return null;
  }

  return sanitizeResumeState(source);
}

function buildRawResumePayload() {
  return {
    app: rawExportConfig.app,
    schemaVersion: rawExportConfig.schemaVersion,
    exportedAt: new Date().toISOString(),
    data: sanitizeResumeState(state)
  };
}

function resetSkillLevelVisibility(resumeState) {
  if (!resumeState || !Array.isArray(resumeState.skills)) {
    return resumeState;
  }

  return {
    ...resumeState,
    skills: resumeState.skills.map((item) => ({
      ...item,
      showLevel: false
    }))
  };
}

function loadDraftFromLocalStorage() {
  try {
    const rawDraft = window.localStorage.getItem(localDraftConfig.key);

    if (!rawDraft) {
      return null;
    }

    const parsedDraft = JSON.parse(rawDraft);
    const parsedState = parseRawResumePayload(parsedDraft);

    if (!parsedState) {
      return null;
    }

    const storedSchemaVersion = Number(parsedDraft?.schemaVersion);
    if (!Number.isFinite(storedSchemaVersion) || storedSchemaVersion < rawExportConfig.schemaVersion) {
      return resetSkillLevelVisibility(parsedState);
    }

    return parsedState;
  } catch (error) {
    console.warn("Could not load draft from localStorage", error);
    return null;
  }
}

function saveDraftToLocalStorage() {
  try {
    window.localStorage.setItem(localDraftConfig.key, JSON.stringify(buildRawResumePayload()));
  } catch (error) {
    console.warn("Could not save draft to localStorage", error);
  }
}

function getRawResumeFilename() {
  const baseName = hasText(state.profile.name) ? state.profile.name : "resume";
  const safeName = baseName
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");

  return `${safeName || "resume"}-raw.json`;
}

function downloadRawResume() {
  const blob = new Blob([JSON.stringify(buildRawResumePayload(), null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");

  link.href = url;
  link.download = getRawResumeFilename();

  document.body.append(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

function syncStaticInputsFromState() {
  refs.templateSelect.value = state.template;

  document.querySelectorAll("[data-profile]").forEach((input) => {
    if (!(input instanceof HTMLInputElement)) {
      return;
    }

    const key = input.dataset.profile;
    if (!key) {
      return;
    }

    input.value = state.profile[key] ?? "";
  });

  const summaryField = refs.editorPanel.querySelector("[data-field='summary']");
  if (summaryField instanceof HTMLTextAreaElement) {
    summaryField.value = state.summary;
  }
}

function applyImportedState(nextState) {
  state.uiLang = nextState.uiLang;
  state.cvLang = nextState.cvLang;
  state.template = nextState.template;
  state.theme = nextState.theme;
  state.showSkills = nextState.showSkills || nextState.skills.length > 0;
  state.profile = nextState.profile;
  state.summary = nextState.summary;
  state.experience = nextState.experience;
  state.education = nextState.education;
  state.skills = nextState.skills;
}

function buildSampleResumeState() {
  return sanitizeResumeState({
    uiLang: state.uiLang,
    cvLang: state.cvLang,
    template: state.template,
    theme: state.theme,
    showSkills: true,
    profile: {
      name: "Lena Hoffmann",
      title: "Senior Product Designer",
      email: "lena.hoffmann@example.com",
      phone: "+49 30 1234 5678",
      location: "Berlin, Germany",
      website: "lenahoffmann.design",
      linkedin: "linkedin.com/in/lenahoffmann",
      github: "github.com/lenahoffmann"
    },
    summary:
      "Product designer with 8+ years building end-to-end digital products for SaaS and consumer platforms. I turn research into clear interaction systems, partner closely with engineering, and ship accessible interfaces that improve adoption and retention.",
    experience: [
      {
        role: "Senior Product Designer",
        company: "Nordlicht Cloud",
        location: "Berlin, Germany",
        start: "2022",
        end: "Present",
        bullets:
          "Led redesign of onboarding flow, reducing drop-off by 29%.\nBuilt a component library with design tokens used across 4 product teams.\nPartnered with PM and engineering to ship roadmap features every sprint."
      },
      {
        role: "Product Designer",
        company: "Blueframe Labs",
        location: "Berlin, Germany",
        start: "2018",
        end: "2022",
        bullets:
          "Created responsive UX patterns for dashboard, billing, and analytics modules.\nRan usability tests and converted findings into prioritized product improvements.\nDefined interaction specs and states to speed up implementation handoff."
      },
      {
        role: "UX Designer",
        company: "Helio Commerce",
        location: "Berlin, Germany",
        start: "2016",
        end: "2018",
        bullets:
          "Redesigned checkout and account flows, improving conversion and repeat purchases.\nCollaborated with engineers to implement a reusable UI kit across web surfaces.\nMapped customer journeys and identified friction points across the funnel."
      },
      {
        role: "Visual Designer",
        company: "Brightside Agency",
        location: "Berlin, Germany",
        start: "2014",
        end: "2016",
        bullets:
          "Delivered brand and digital design systems for early-stage technology clients.\nProduced high-fidelity web and marketing assets with clear design rationale.\nSupported stakeholder workshops to align design direction and business goals."
      },
      {
        role: "Design Intern",
        company: "Studio Mitte",
        location: "Berlin, Germany",
        start: "2013",
        end: "2014",
        bullets:
          "Assisted with wireframes, prototypes, and visual explorations for client projects.\nPrepared design specs and asset exports for front-end implementation.\nContributed to user interviews and synthesized notes into actionable insights."
      }
    ],
    education: [
      {
        degree: "B.A. in Interaction Design",
        school: "Berlin University of the Arts",
        location: "Berlin, Germany",
        start: "2012",
        end: "2016"
      }
    ],
    skills: [
      { name: "Product Strategy", level: "expert", showLevel: false },
      { name: "UX Research", level: "advanced", showLevel: false },
      { name: "Interaction Design", level: "expert", showLevel: false },
      { name: "Design Systems", level: "advanced", showLevel: false },
      { name: "Figma", level: "expert", showLevel: false },
      { name: "Prototyping", level: "advanced", showLevel: false },
      { name: "Accessibility", level: "advanced", showLevel: false },
      { name: "HTML/CSS", level: "intermediate", showLevel: false }
    ]
  });
}

function buildEmptyResumeState() {
  return sanitizeResumeState({
    uiLang: state.uiLang,
    cvLang: state.cvLang,
    template: state.template,
    theme: state.theme,
    showSkills: false,
    profile: {
      name: "",
      title: "",
      email: "",
      phone: "",
      location: "",
      website: "",
      linkedin: "",
      github: ""
    },
    summary: "",
    experience: [],
    education: [],
    skills: []
  });
}

function syncSampleButtonState() {
  if (!refs.sampleBtn) {
    return;
  }

  refs.sampleBtn.setAttribute("aria-pressed", String(sampleModeEnabled));
}

async function handleRawFileChange(event) {
  const target = event.target;

  if (!(target instanceof HTMLInputElement)) {
    return;
  }

  const file = target.files?.[0];
  if (!file) {
    return;
  }

  try {
    const content = await file.text();
    const parsed = JSON.parse(content);
    const importedState = parseRawResumePayload(parsed);

    if (!importedState) {
      throw new Error("Invalid raw resume payload");
    }

    applyImportedState(importedState);
    sampleModeEnabled = false;
    syncStaticInputsFromState();
    applyTheme();
    applyI18n();
    renderDynamicEditors();
    renderPreview();
    syncSampleButtonState();
  } catch (error) {
    console.error(error);
    window.alert(t("errors.invalidRawFile"));
  } finally {
    target.value = "";
  }
}

function createExperience() {
  return {
    role: "",
    company: "",
    location: "",
    start: "",
    end: "",
    bullets: ""
  };
}

function createEducation() {
  return {
    degree: "",
    school: "",
    location: "",
    start: "",
    end: ""
  };
}

function createSkill() {
  return {
    name: "",
    level: "intermediate",
    showLevel: false
  };
}

function renderExperienceEditor() {
  if (!state.experience.length) {
    refs.experienceList.innerHTML = `<p class="empty-list">${t("empty.experienceEditor")}</p>`;
    return;
  }

  refs.experienceList.innerHTML = state.experience
    .map(
      (item, index) => `
        <article class="repeat-item">
          <div class="repeat-item-head">
            <p class="repeat-item-title">${t("fields.experience")} ${index + 1}</p>
            <button type="button" class="remove-btn" data-action="remove-experience" data-index="${index}">
              ${t("actions.remove")}
            </button>
          </div>

          <div class="repeat-item-grid">
            <label>
              <span>${t("fields.jobTitle")}</span>
              <input type="text" data-list="experience" data-index="${index}" data-key="role" value="${escapeAttr(item.role)}" placeholder="${t("placeholders.jobTitle")}" />
            </label>
            <label>
              <span>${t("fields.company")}</span>
              <input type="text" data-list="experience" data-index="${index}" data-key="company" value="${escapeAttr(item.company)}" placeholder="${t("placeholders.company")}" />
            </label>
            <label>
              <span>${t("fields.itemLocation")}</span>
              <input type="text" data-list="experience" data-index="${index}" data-key="location" value="${escapeAttr(item.location)}" placeholder="${t("placeholders.location")}" />
            </label>
            <label>
              <span>${t("fields.startDate")}</span>
              <input type="text" data-list="experience" data-index="${index}" data-key="start" value="${escapeAttr(item.start)}" placeholder="2022" />
            </label>
            <label>
              <span>${t("fields.endDate")}</span>
              <input type="text" data-list="experience" data-index="${index}" data-key="end" value="${escapeAttr(item.end)}" placeholder="${t("placeholders.present")}" />
            </label>
          </div>

          <label>
            <span>${t("fields.highlights")}</span>
            <textarea rows="3" data-list="experience" data-index="${index}" data-key="bullets">${escapeHtml(item.bullets)}</textarea>
          </label>
        </article>
      `
    )
    .join("");
}

function renderEducationEditor() {
  if (!state.education.length) {
    refs.educationList.innerHTML = `<p class="empty-list">${t("empty.educationEditor")}</p>`;
    return;
  }

  refs.educationList.innerHTML = state.education
    .map(
      (item, index) => `
        <article class="repeat-item">
          <div class="repeat-item-head">
            <p class="repeat-item-title">${t("fields.education")} ${index + 1}</p>
            <button type="button" class="remove-btn" data-action="remove-education" data-index="${index}">
              ${t("actions.remove")}
            </button>
          </div>

          <div class="repeat-item-grid">
            <label>
              <span>${t("fields.degree")}</span>
              <input type="text" data-list="education" data-index="${index}" data-key="degree" value="${escapeAttr(item.degree)}" placeholder="${t("placeholders.degree")}" />
            </label>
            <label>
              <span>${t("fields.school")}</span>
              <input type="text" data-list="education" data-index="${index}" data-key="school" value="${escapeAttr(item.school)}" placeholder="${t("placeholders.school")}" />
            </label>
            <label>
              <span>${t("fields.itemLocation")}</span>
              <input type="text" data-list="education" data-index="${index}" data-key="location" value="${escapeAttr(item.location)}" placeholder="${t("placeholders.location")}" />
            </label>
            <label>
              <span>${t("fields.startDate")}</span>
              <input type="text" data-list="education" data-index="${index}" data-key="start" value="${escapeAttr(item.start)}" placeholder="2018" />
            </label>
            <label>
              <span>${t("fields.endDate")}</span>
              <input type="text" data-list="education" data-index="${index}" data-key="end" value="${escapeAttr(item.end)}" placeholder="2022" />
            </label>
          </div>
        </article>
      `
    )
    .join("");
}

function renderSkillsEditor() {
  if (!state.skills.length) {
    refs.skillsList.innerHTML = `<p class="empty-list">${t("empty.skillsEditor")}</p>`;
    return;
  }

  refs.skillsList.innerHTML = state.skills
    .map(
      (item, index) => `
        <article class="repeat-item">
          <div class="repeat-item-head">
            <p class="repeat-item-title">${t("fields.skillName")} ${index + 1}</p>
            <button type="button" class="remove-btn" data-action="remove-skill" data-index="${index}">
              ${t("actions.remove")}
            </button>
          </div>

          <div class="repeat-item-grid skill-editor-grid">
            <label>
              <span>${t("fields.skillName")}</span>
              <input type="text" data-list="skills" data-index="${index}" data-key="name" value="${escapeAttr(item.name)}" placeholder="${t("placeholders.skill")}" />
            </label>
            <label>
              <span>${t("fields.skillLevel")}</span>
              <select data-list="skills" data-index="${index}" data-key="level">
                ${skillLevels
                  .map(
                    (level) =>
                      `<option value="${level}" ${
                        normalizeSkillLevel(item.level) === level ? "selected" : ""
                      }>${t(`levels.${level}`)}</option>`
                  )
                  .join("")}
              </select>
            </label>
          </div>
          <button
            type="button"
            class="skill-level-toggle${toBoolean(item.showLevel, false) ? " is-active" : ""}"
            data-action="toggle-skill-level"
            data-index="${index}"
            aria-pressed="${toBoolean(item.showLevel, false)}"
          >
            ${t("fields.showSkillLevel")}
          </button>
        </article>
      `
    )
    .join("");
}

function isResumeBlank() {
  const profileHasContent = Object.values(state.profile).some(hasText);
  const summaryHasContent = hasText(state.summary);
  const experienceHasContent = getExperienceItems().length > 0;
  const educationHasContent = getEducationItems().length > 0;
  const skillsHasContent = getSkillItems().length > 0;

  return !(profileHasContent || summaryHasContent || experienceHasContent || educationHasContent || skillsHasContent);
}

function applyTheme() {
  document.body.classList.toggle("theme-dark", state.theme === "dark");
  refs.themeToggle.setAttribute("aria-pressed", String(state.theme === "dark"));
}

function applyI18n() {
  document.documentElement.lang = state.uiLang;

  document.querySelectorAll("[data-i18n]").forEach((element) => {
    const key = element.getAttribute("data-i18n");
    if (key) {
      element.textContent = t(key);
    }
  });

  document.querySelectorAll("[data-i18n-placeholder]").forEach((element) => {
    const key = element.getAttribute("data-i18n-placeholder");
    if (key) {
      element.setAttribute("placeholder", t(key));
    }
  });

  refs.themeToggle.querySelector("[data-role='theme-label']").textContent =
    state.theme === "dark" ? t("actions.lightMode") : t("actions.darkMode");

  document.querySelectorAll(".lang-btn").forEach((button) => {
    const isActive = button.getAttribute("data-lang") === state.uiLang;
    button.classList.toggle("active", isActive);
    button.setAttribute("aria-pressed", String(isActive));
  });

  document.querySelectorAll(".cv-lang-btn").forEach((button) => {
    const isActive = button.getAttribute("data-cv-lang") === state.cvLang;
    button.classList.toggle("active", isActive);
    button.setAttribute("aria-pressed", String(isActive));
  });
}

function renderDynamicEditors() {
  renderExperienceEditor();
  renderEducationEditor();
  renderSkillsEditor();
}

function syncEditorPanelHeight() {
  if (!refs.editorPanel || !refs.previewPanel) {
    return;
  }

  const isDesktop = window.matchMedia("(min-width: 1181px)").matches;
  if (!isDesktop) {
    refs.editorPanel.style.height = "";
    refs.editorPanel.style.maxHeight = "";
    return;
  }

  const previewHeight = Math.round(refs.previewPanel.getBoundingClientRect().height);
  if (previewHeight > 0) {
    refs.editorPanel.style.height = `${previewHeight}px`;
    refs.editorPanel.style.maxHeight = `${previewHeight}px`;
  }
}

function renderPreview() {
  const templateConfig = templateCatalog[state.template] ?? templateCatalog.berlin;
  refs.resumePreview.className =
    `resume-preview ${templateConfig.baseClass}${templateConfig.variantClass ? ` ${templateConfig.variantClass}` : ""}`;
  refs.resumePreview.innerHTML = templateConfig.render();
  refs.blankPill.hidden = !isResumeBlank();
  syncEditorPanelHeight();
  saveDraftToLocalStorage();
}

function handleInput(event) {
  const target = event.target;

  if (!(target instanceof HTMLInputElement || target instanceof HTMLTextAreaElement || target instanceof HTMLSelectElement)) {
    return;
  }

  if (target.dataset.profile) {
    state.profile[target.dataset.profile] = target.value;
    renderPreview();
    return;
  }

  if (target.dataset.field === "summary") {
    state.summary = target.value;
    renderPreview();
    return;
  }

  if (target.dataset.list && target.dataset.key) {
    const listName = target.dataset.list;
    const index = Number(target.dataset.index);
    const key = target.dataset.key;

    if (!Number.isNaN(index) && state[listName]?.[index]) {
      state[listName][index][key] =
        target instanceof HTMLInputElement && target.type === "checkbox" ? target.checked : target.value;
      renderPreview();
    }
    return;
  }

  if (target.id === "template-select") {
    state.template = target.value;
    renderPreview();
    return;
  }

}

function handleClick(event) {
  const trigger = event.target.closest("button");

  if (!trigger) {
    return;
  }

  if (trigger.classList.contains("lang-btn")) {
    state.uiLang = trigger.getAttribute("data-lang") || "en";
    applyI18n();
    renderDynamicEditors();
    renderPreview();
    return;
  }

  if (trigger.classList.contains("cv-lang-btn")) {
    state.cvLang = trigger.getAttribute("data-cv-lang") || "en";
    applyI18n();
    renderPreview();
    return;
  }

  if (trigger.id === "theme-toggle") {
    state.theme = state.theme === "dark" ? "light" : "dark";
    applyTheme();
    applyI18n();
    saveDraftToLocalStorage();
    return;
  }

  if (trigger.id === "add-experience-btn") {
    state.experience.push(createExperience());
    renderDynamicEditors();
    renderPreview();
    return;
  }

  if (trigger.id === "add-education-btn") {
    state.education.push(createEducation());
    renderDynamicEditors();
    renderPreview();
    return;
  }

  if (trigger.id === "add-skill-btn") {
    state.skills.push(createSkill());
    state.skills[state.skills.length - 1].showLevel = false;
    renderDynamicEditors();
    renderPreview();
    return;
  }

  if (trigger.id === "upload-raw-btn") {
    refs.rawFileInput?.click();
    return;
  }

  if (trigger.id === "sample-btn") {
    const nextState = sampleModeEnabled ? buildEmptyResumeState() : buildSampleResumeState();

    applyImportedState(nextState);
    sampleModeEnabled = !sampleModeEnabled;
    syncStaticInputsFromState();
    applyI18n();
    renderDynamicEditors();
    renderPreview();
    syncSampleButtonState();
    return;
  }

  if (trigger.id === "download-raw-btn") {
    downloadRawResume();
    return;
  }

  if (trigger.dataset.action === "remove-experience") {
    const index = Number(trigger.dataset.index);
    if (!Number.isNaN(index)) {
      state.experience.splice(index, 1);
      renderDynamicEditors();
      renderPreview();
    }
    return;
  }

  if (trigger.dataset.action === "remove-education") {
    const index = Number(trigger.dataset.index);
    if (!Number.isNaN(index)) {
      state.education.splice(index, 1);
      renderDynamicEditors();
      renderPreview();
    }
    return;
  }

  if (trigger.dataset.action === "remove-skill") {
    const index = Number(trigger.dataset.index);
    if (!Number.isNaN(index)) {
      state.skills.splice(index, 1);
      renderDynamicEditors();
      renderPreview();
    }
    return;
  }

  if (trigger.dataset.action === "toggle-skill-level") {
    const index = Number(trigger.dataset.index);
    if (!Number.isNaN(index) && state.skills[index]) {
      state.skills[index].showLevel = !toBoolean(state.skills[index].showLevel, false);
      renderDynamicEditors();
      renderPreview();
    }
    return;
  }

  if (trigger.id === "pdf-btn") {
    openPdfDialog();
    return;
  }

  if (trigger.id === "privacy-btn") {
    refs.privacyModal?.showModal();
    return;
  }

  if (trigger.id === "privacy-close-btn") {
    refs.privacyModal?.close();
    try { localStorage.setItem("free-resume:privacy-ack", "1"); } catch {}
    return;
  }
}

function init() {
  const savedDraft = loadDraftFromLocalStorage();
  if (savedDraft) {
    applyImportedState(savedDraft);
  }

  syncStaticInputsFromState();

  applyTheme();
  applyI18n();
  renderDynamicEditors();
  renderPreview();
  syncSampleButtonState();

  refs.rawFileInput?.addEventListener("change", handleRawFileChange);
  refs.editorPanel.addEventListener("input", handleInput);
  refs.editorPanel.addEventListener("change", handleInput);
  window.addEventListener("resize", syncEditorPanelHeight);
  document.addEventListener("click", handleClick);

  if ("ResizeObserver" in window && refs.previewPanel) {
    const previewPanelObserver = new ResizeObserver(() => {
      syncEditorPanelHeight();
    });
    previewPanelObserver.observe(refs.previewPanel);
  }

  refs.privacyModal?.addEventListener("click", (event) => {
    if (event.target === refs.privacyModal) {
      refs.privacyModal.close();
      try { localStorage.setItem("free-resume:privacy-ack", "1"); } catch {}
    }
  });

}

init();
